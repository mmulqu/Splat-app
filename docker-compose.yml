version: '3.8'

services:
  splat-local:
    build:
      context: ./local-server
      dockerfile: Dockerfile
    container_name: gaussian-splatting-local
    ports:
      - "5000:5000"
    volumes:
      # Mount volumes for persistent storage
      - ./local-data/uploads:/workspace/uploads
      - ./local-data/outputs:/workspace/outputs
      # Optional: Mount your own images directory
      # - ./my-images:/workspace/my-images:ro
    environment:
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    restart: unless-stopped
    stdin_open: true
    tty: true

  # Optional: GPU monitoring with nvidia-smi
  gpu-monitor:
    image: nvidia/cuda:11.8.0-base-ubuntu22.04
    container_name: gpu-monitor
    command: watch -n 1 nvidia-smi
    environment:
      - NVIDIA_VISIBLE_DEVICES=all
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    profiles:
      - monitoring
